/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NativeWebKit={})}(this,(function(e){"use strict";class t{get eventTypes(){return[]}#e(e){return 0==this.eventTypes.length||this.eventTypes.includes(e)}#t(e){if(!this.#e(e))throw Error(`invalid event type "${e}"`)}#s;addEventListener(e,t,s){if(this.#t(e),this.#s||(this.#s={}),s?.once){const s=t;t=function t(i){s.apply(this,arguments),this.removeEventListener(e,t)}}const i=this.#s;i[e]||(i[e]=[]),i[e].includes(t)||i[e].push(t)}hasEventListener(e,t){return this.#t(e),this.#s?.[e]?.includes(t)}removeEventListener(e,t){if(this.#t(e),this.hasEventListener(e,t)){const s=this.#s[e].indexOf(t);return this.#s[e].splice(s,1),!0}return!1}dispatchEvent(e){if(this.#t(e.type),this.#s?.[e.type]){e.target=this;const t=this.#s[e.type].slice(0);for(let s=0,i=t.length;s<i;s++)t[s].call(this,e)}}get _prefix(){return""}_formatMessage(e){const t={...e};return t.type=`${this._prefix}-${e.type}`,t}}class s{#i=function(){};set prefix(e){const t=[console];e&&(Array.isArray(e)?t.push(...e):t.push(e)),this.#n=console.log.bind(...t),this.#a=console.warn.bind(...t),this.#r=console.error.bind(...t)}isLoggingEnabled=!0;get log(){return this.#i}#n=console.log.bind(console);isWarningEnabled=!0;get warn(){return this.#i}#a=console.warn.bind(console);isErrorEnabled=!0;get error(){return this.#i}#r=console.error.bind(console);set isEnabled(e){this.isLoggingEnabled=e,this.isWarningEnabled=e,this.isErrorEnabled=e}constructor(e){e&&(this.prefix=e)}}const i=new s,{userAgent:n}=navigator,a=/Safari/i.test(n)&&!/Chrome/i.test(n),r=/NativeWebKit/i.test(n);var o=Boolean(window.isNativeWebKitSafariExtensionInstalled);const l=async()=>!!(o=o||Boolean(window.isNativeWebKitSafariExtensionInstalled))||(i.log("checking if Safari Extension is installed..."),new Promise((e=>{const t=()=>{i.log("Safari Extension is installed"),o=!0,e(!0)};window.addEventListener("nativewebkit-extension-is-installed",t,{once:!0}),window.dispatchEvent(new Event("is-nativewebkit-extension-installed")),window.setTimeout((()=>{o||(i.log("Safari Extension is not installed"),window.removeEventListener("nativewebkit-extension-is-installed",t),e(!1))}),1)})));const c=async()=>!!(r||o)||await l(),p=/iPad|iPhone|iPod/.test(n),d=/Macintosh/.test(n),g=new s,h=new Set;const u={};function v(e,t){g.log(`adding callback with prefix "${t}"`,e),u[t]||(u[t]=[]),u[t].push(e)}function f(e){Array.isArray(e)||(e=[e]),g.log("nativewebkit-receive messages",e),e.forEach((e=>{const[t,s]=e.type.split("-");g.log(`received "${t}" message of type "${s}"`,e),e.type=s,u[t]&&0!=u[t].length?u[t].forEach((t=>{g.log("triggering callback",t,"for message",e),t(e)})):g.warn("no callbacks listening for prefix",t)}))}window.__NATIVEWEBKIT_MESSAGING_FLAG__||(window.__NATIVEWEBKIT_MESSAGING_FLAG__=!0,g.log('adding "nativewebkit-receive" window listener'),window.addEventListener("nativewebkit-receive",(e=>{f(e.detail)})),window.addEventListener("load",(()=>{g.log("triggering window.load events...");const e=u["window.load"]?.map((e=>e())).flat().filter(Boolean);e.length>0&&b(e)})),window.addEventListener("unload",(()=>{g.log("triggering window.unload events...");const e=u["window.unload"]?.map((e=>e())).flat().filter(Boolean);e.length>0&&b(e)})));var k,w,m=[];async function b(e,t=!0){if(await c()){if(g.log("requesting to send message",e,"send immediately?",t),!e&&0==m.length)return void g.warn("no messages received, and no pending messages");if(e&&(0==m.length&&(k=new Promise((e=>{w=e}))),m.push(e),m=m.flat()),0==m.length)return void g.log("no messages to send");if(!t)return k;if(g.log("sending messages to app...",m),r){const e=await webkit.messageHandlers.nativewebkit_reply.postMessage(m);g.log("app response",e),e&&f(e),w(!0)}else{const e=function(){for(var e=0;h.has(e);)e++;return h.add(e),e}();window.dispatchEvent(new CustomEvent("nativewebkit-send",{detail:{message:m,id:e}})),window.addEventListener(`nativewebkit-receive-${e}`,(t=>{const s=t.detail;g.log(`did receive message for nativewebkit-receive-${e}?`,s),s||g.error(`didn't receive message for nativewebkit-receive-${e}`),w(s),h.delete(e)}),{once:!0})}return m.length=0,k}g.warn("NativeWebKit.js is not enabled - run in the NativeWebKit app or enable the NativeWebKit Safari Web Extension")}const y=new s;function E(e,t){return 0===t?e:E(t,e%t)}function A(e){if(y.log("finding greatestCommonFactor of numbers",e),0==(e=e.filter((e=>e>0))).length)return null;const t=e.reduce(((e,t)=>E(e,t)));return y.log("greatestCommonFactor",t),0==t?null:t}const S=new s("AppMessagePoll");class M{#o=!1;async#l(){if(!await c())return!1;if(r)return this.#o;return await l()}static#c=[];static#p(e){return this.#c.includes(e)?(S.log("poll already included"),this.#c.indexOf(e)):this.#c.push(e)}static#d(e){return this.#c.includes(e)?(e.stop(),this.#c.splice(e,e.#g),this.#h(),!0):(S.log("poll wasn't included"),!1)}get#g(){return M.#c.indexOf(this)}#u;#v;#f=0;get interval(){return this.#v}set interval(e){e<=0?S.error(`invalid interval ${e}ms`):e!=this.#v?(this.#v=e,this.#k&&M.#h()):S.warn("assigning same interval")}constructor(e,t,s=!1){this.#u=e,this.#v=t,this.#o=s,M.#p(this)}static#w=null;static get#m(){return null!=this.#w}static#b=null;static get#y(){return this.#c.filter((e=>e.#E))}static get#A(){return this.#y.map((e=>e.#v))}static#S(){var e=A(this.#A);if(S.log(`new interval ${e}`),this.#b!=e)return S.log(`interval updated from ${this.#b} to ${e}`),this.#b=e,!0}static async#M(){const e=Date.now(),t=this.#y.filter((t=>e-t.#f>=t.#v)),s=t.map((e=>e.#u()));if(S.log("messages",s),s.length>0){const e=await b(s);S.log("didReceiveMessage?",e),e||S.error("app didn't receive message")}else S.log("no messages to send");t.forEach((t=>t.#f=e))}static#T(){this.#m?S.log("tried to start AppMessagePoll when it's already running"):null!=this.#b?(S.log(`starting interval at ${this.#b}`),this.#w=window.setInterval(this.#M.bind(this),this.#b)):S.log("null interval")}static#L(){this.#m?(window.clearInterval(this.#w),this.#w=null):S.log("tried to stop AppMessagePoll when it already isn't running")}static#h(e=!1){if(!this.#m&&!e)return;const t=this.#S();this.#m||t?(S.log("restarting..."),this.#L(),this.#T()):S.log("no need to restart")}#E=!1;get#k(){return M.#m&&this.#E}async start(){await this.#l()&&(this.#k?S.log("poll is already running"):(this.#E=!0,M.#h(!0)))}stop(){this.#k&&(this.#E=!1,M.#h())}destroy(){S.log("destroying poll",this),M.#d(this)}}const T=new s("HeadphoneMotionManager");class L extends t{static#I=["isAvailable","isActive","motionData","sensorLocation"];get eventTypes(){return L.#I}static#O=new L;static get shared(){return this.#O}get _prefix(){return"hm"}_formatMessage(e){return super._formatMessage(e)}addEventListener(e,t,s){return super.addEventListener(...arguments)}removeEventListener(e,t){return super.removeEventListener(...arguments)}hasEventListener(e,t){return super.hasEventListener(...arguments)}dispatchEvent(e){return super.dispatchEvent(...arguments)}constructor(){if(super(),this.shared)throw new Error("HeadphoneMotionManager is a singleton - use HeadphoneMotionManager.shared");v(this.#U.bind(this),"window.load"),v(this.#R.bind(this),this._prefix),v(this.#_.bind(this),"window.unload")}#U(){if(this.#W)return this.#x}#_(){if(this.#D&&this.#F)return this.#$}#W=!1;get checkAvailabilityOnLoad(){return this.#W}set checkAvailabilityOnLoad(e){if("boolean"!=typeof e)throw Error("invalid newValue for checkAvailabilityOnLoad",e);this.#W=e}#F=!0;get stopUpdatesOnUnload(){return this.#F}set stopUpdatesOnUnload(e){if("boolean"!=typeof e)throw Error("invalid newValue for stopUpdatesOnUnload",e);this.#F=e}#R(e){T.log(`received background message of type ${e.type}`,e);const{type:t}=e;switch(t){case"isAvailable":this.#P(e.isAvailable);break;case"isActive":this.#N(e.isActive);break;case"getData":this.#V(e.motionData);break;default:T.error(`uncaught message type ${t}`)}}#C=null;get isAvailable(){return Boolean(this.#C)}#P(e){this.#C!=e&&(this.#C=e,T.log(`updated isAvailable to ${e}`),this.dispatchEvent({type:"isAvailable",message:{isAvailable:this.isAvailable}}),this.#C&&this.checkIsActive())}async checkIsAvailable(){return T.log("checking isAvailable..."),b(this.#x)}get#x(){return this._formatMessage({type:"isAvailable"})}#D=null;get isActive(){return Boolean(this.#D)}#N(e){this.#D!=e&&(this.#D=e,T.log(`updated isActive to ${this.isActive}`),this.dispatchEvent({type:"isActive",message:{isActive:this.isActive}}),this.#K.stop(),this.#D?(T.log("starting motion data poll"),this.#j.start()):(T.log("stopping motion data poll"),this.#j.stop()))}async checkIsActive(){return T.log("checking isActive"),b(this.#B())}#B(){return this._formatMessage({type:"isActive"})}#K=new M(this.#B.bind(this),50,!0);async startUpdates(){if(this.isAvailable){if(!this.isActive)return T.log("starting motion updates"),this.#K.start(),b(this.#G);T.warn("already active")}else T.warn("not available")}get#G(){return this._formatMessage({type:"startUpdates"})}async stopUpdates(){if(this.isAvailable){if(this.isActive)return T.log("stopping motion updates"),this.#K.start(),b(this.#$);T.warn("already inactive")}else T.warn("not available")}get#$(){return this._formatMessage({type:"stopUpdates"})}async toggleMotionUpdates(){if(this.isAvailable)return this.isActive?this.stopUpdates():this.startUpdates();T.log("not available")}#H;get motionData(){return this.#H}get#q(){return this.motionData?.timestamp||0}#z=null;get sensorLocation(){return this.#z}#J(e){this.#z!=e&&(this.#z=e,T.log(`updated sensor location to ${e}`),this.dispatchEvent({type:"sensorLocation",message:{sensorLocation:this.sensorLocation}}))}#V(e){this.#H=e,T.log("received headphone motion data",this.motionData),this.dispatchEvent({type:"motionData",message:{motionData:this.motionData}}),this.#J(e.sensorLocation)}async checkMotionData(){return T.log("checkMotionData"),b(this.#Q)}#Q(){return this._formatMessage({type:"getData",timestamp:this.#q})}#j=new M(this.#Q.bind(this),20)}var I=L.shared;function O(e,t){if("object"!=typeof e||"object"!=typeof t)return!1;const s=Object.keys(e),i=Object.keys(t);if(s.length!=i.length)return!1;return s.every((s=>s in t&&e[s]==t[s]))}const U=new s("ARSession");class R extends t{static#I=["worldTrackingSupport","faceTrackingSupport","isRunning","frame","camera"];get eventTypes(){return R.#I}static#O=new R;static get shared(){return this.#O}get _prefix(){return"ars"}_formatMessage(e){return super._formatMessage(e)}addEventListener(e,t,s){return super.addEventListener(...arguments)}removeEventListener(e,t){return super.removeEventListener(...arguments)}hasEventListener(e,t){return super.hasEventListener(...arguments)}dispatchEvent(e){return super.dispatchEvent(...arguments)}constructor(){if(super(),this.shared)throw new Error("ARSessionManager is a singleton - use ARSessionManager.shared");v(this.#U.bind(this),"window.load"),v(this.#R.bind(this),this._prefix),v(this.#_.bind(this),"window.unload")}get isSupported(){return p&&r}#X(){d?U.warn("AR Session is not supported on Mac"):U.warn("AR Session not supported in iOS Safari")}#U(){if(!this.isSupported)return;const e=[];return this.checkFaceTrackingSupportOnLoad&&e.push(this.#Y),this.checkWorldTrackingSupportOnLoad&&e.push(this.#Z),this.checkIsRunningOnLoad&&e.push(this.#ee),e}#_(){if(!this.isSupported)return;const e=[];return this.pauseOnUnload&&this.isRunning&&e.push(this.#te),e}#se={isSupported:!1,supportsUserFaceTracking:!1};get worldTrackingSupport(){return this.#se}#ie(e){O(this.#se,e)||(this.#se=e,U.log("updated worldTrackingSupport",e),this.dispatchEvent({type:"worldTrackingSupport",message:{worldTrackingSupport:this.worldTrackingSupport}}))}#ne=!1;get checkWorldTrackingSupportOnLoad(){return this.#ne}set checkWorldTrackingSupportOnLoad(e){if("boolean"!=typeof e)throw Error("invalid newValue for checkWorldTrackingSupportOnLoad",e);this.#ne=e}async checkWorldTrackingSupport(){if(this.isSupported)return U.log("checking world tracking support..."),b(this.#Z);this.#X()}get#Z(){return this._formatMessage({type:"worldTrackingSupport"})}#ae={isSupported:!1,supportsWorldTracking:!1};get faceTrackingSupport(){return this.#ae}#re(e){O(this.#ae,e)||(this.#ae=e,U.log("updated faceTrackingSupport",e),this.dispatchEvent({type:"faceTrackingSupport",message:{faceTrackingSupport:this.faceTrackingSupport}}))}#oe=!1;get checkFaceTrackingSupportOnLoad(){return this.#oe}set checkFaceTrackingSupportOnLoad(e){if("boolean"!=typeof e)throw Error("invalid newValue for checkFaceTrackingSupportOnLoad",e);this.#oe=e}async checkFaceTrackingSupport(){if(this.isSupported)return U.log("checking face tracking support..."),b(this.#Y);this.#X()}get#Y(){return this._formatMessage({type:"faceTrackingSupport"})}#k=!1;get isRunning(){return this.#k}#le(e){this.#k!=e&&(this.#k=e,U.log(`updated isRunning to ${e}`),this.dispatchEvent({type:"isRunning",message:{isRunning:this.isRunning}}))}async checkIsRunning(){if(this.isSupported)return U.log("checking isRunning..."),b(this.#ee);this.#X()}get#ee(){return this._formatMessage({type:"isRunning"})}#ce=!1;get checkIsRunningOnLoad(){return this.#ce}set checkIsRunningOnLoad(e){if("boolean"!=typeof e)throw Error("invalid newValue for checkIsRunningOnLoad",e);this.#ce=e}#pe=!0;get pauseOnUnload(){return this.#pe}set pauseOnUnload(e){if("boolean"!=typeof e)throw Error("invalid newValue for pauseOnUnload",e);this.#pe=e}async run(){return U.log("run..."),b(this.#de)}get#de(){return this._formatMessage({type:"run"})}async pause(){return U.log("pause..."),b(this.#te)}get#te(){return this._formatMessage({type:"pause"})}#ge=null;get frame(){return this.#ge}#he;get camera(){return this.#he}#ue(e){this.#ge=e,U.log("received frame",this.frame),this.dispatchEvent({type:"frame",message:{frame:this.frame}}),this.#ve(e.camera)}#ve(e){this.#he=e,U.log("received camera",this.camera),this.dispatchEvent({type:"camera",message:{camera:this.camera}})}#R(e){U.log(`received background message of type ${e.type}`,e);const{type:t}=e;switch(t){case"faceTrackingSupport":U.log("received faceTrackingSupport message",e),this.#re(e.faceTrackingSupport);break;case"worldTrackingSupport":U.log("received worldTrackingSupport message",e),this.#ie(e.worldTrackingSupport);break;case"isRunning":U.log("received isRunning message",e),this.#le(e.isRunning);break;case"frame":U.log("received frame message",e),this.#ue(e.frame);break;default:U.error(`uncaught message type ${t}`)}}}var _=R.shared,W=Object.freeze({__proto__:null,areObjectsEqual:O,checkIfNativeWebKitEnabled:c,checkIfSafariExtensionIsInstalled:l,isInApp:r,isInSafari:a,isMac:d,is_iOS:p,openInApp:()=>{if(a){const e=document.createElement("a"),t=`nativewebkit://${location.href}`;i.log("attempting to open current link in App...",location.href,t),e.href=t,e.click()}else i.warn("unable to open link in app - not in safari")}});e.ARSessionManager=_,e.HeadphoneMotionManager=I,e.utils=W}));
