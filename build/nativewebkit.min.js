/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NativeWebKit={})}(this,(function(e){"use strict";class t{#e=function(){};set prefix(e){const t=[console];e&&(Array.isArray(e)?t.push(...e):t.push(e)),this.#t=console.log.bind(...t),this.#s=console.warn.bind(...t),this.#i=console.error.bind(...t)}isLoggingEnabled=!1;get log(){return this.isLoggingEnabled?this.#t:this.#e}#t=console.log.bind(console);isWarningEnabled=!1;get warn(){return this.isWarningEnabled?this.#s:this.#e}#s=console.warn.bind(console);isErrorEnabled=!0;get error(){return this.isErrorEnabled?this.#i:this.#e}#i=console.error.bind(console);set isEnabled(e){this.isLoggingEnabled=e,this.isWarningEnabled=e,this.isErrorEnabled=e}constructor(e){e&&(this.prefix=e)}}const s=new t,{userAgent:i}=navigator,n=/Safari/i.test(i)&&!/Chrome/i.test(i),a=/NativeWebKit/i.test(i);var o=!1;const r=async()=>!!n&&(window.isNativeWebKitSafariExtensionInstalled?(s.log("window.isNativeWebKitSafariExtensionInstalled is true"),!0):new Promise((e=>{const t=()=>{s.log('received "nativewebkit-is-enabled" response from content.js'),o=!0,e(!0)};window.addEventListener("nativewebkit-is-enabled",t,{once:!0}),setTimeout((()=>{window.isNativeWebKitSafariExtensionInstalled&&(s.log("window.isNativeWebKitSafariExtensionInstalled is true after timeout"),e(!0)),s.log('"nativewebkit-is-enabled" timeout ran out'),o||(e(!1),window.removeEventListener("nativewebkit-is-enabled",t))}),0),s.log('sending "nativewebkit-is-enabled" request to content.js'),window.dispatchEvent(new Event("is-nativewebkit-enabled"))})));class l{get eventTypes(){return[]}#n(e){return 0==this.eventTypes.length||this.eventTypes.includes(e)}#a(e){if(!this.#n(e))throw Error(`invalid event type "${e}"`)}#o;addEventListener(e,t,s){if(this.#a(e),this.#o||(this.#o={}),s?.once){const s=t;t=function t(i){s.apply(this,arguments),this.removeEventListener(e,t)}}const i=this.#o;i[e]||(i[e]=[]),i[e].includes(t)||i[e].push(t)}hasEventListener(e,t){return this.#a(e),this.#o?.[e]?.includes(t)}removeEventListener(e,t){if(this.#a(e),this.hasEventListener(e,t)){const s=this.#o[e].indexOf(t);return this.#o[e].splice(s,1),!0}return!1}dispatchEvent(e){if(this.#a(e.type),this.#o?.[e.type]){e.target=this;const t=this.#o[e.type].slice(0);for(let s=0,i=t.length;s<i;s++)t[s].call(this,e)}}get _prefix(){return""}_formatMessage(e){const t={...e};return t.type=`${this._prefix}-${e.type}`,t}}const d=new t,c=new Set;const h={};function g(e,t){d.log(`adding callback with prefix "${t}"`,e),h[t]||(h[t]=[]),h[t].push(e)}function v(e){Array.isArray(e)||(e=[e]),d.log("nativewebkit-receive messages",e),e.forEach((e=>{const[t,s]=e.type.split("-");d.log(`received "${t}" message of type "${s}"`,e),e.type=s,h[t]&&0!=h[t].length?h[t].forEach((t=>{d.log("triggering callback",t,"for message",e),t(e)})):d.warn("no callbacks listening for prefix",t)}))}async function p(e){if(await(async()=>!!a||(o||(s.log("checking if safari extension is installed..."),o=await r(),s.log(`isSafariExtensionInstalled? ${o}`)),o))()){if(d.log("sending message to app...",e),a){const t=await webkit.messageHandlers.nativewebkit_reply.postMessage(e);return d.log("app response",t),t&&v(t),!0}return new Promise((t=>{const s=function(){for(var e=0;c.has(e);)e++;return c.add(e),e}();window.dispatchEvent(new CustomEvent("nativewebkit-send",{detail:{message:e,id:s}})),window.addEventListener(`nativewebkit-receive-${s}`,(e=>{const i=e.detail;d.log(`did receive message for nativewebkit-receive-${s}?`,i),i||d.error(`didn't receive message for nativewebkit-receive-${s}`),t(i),c.delete(s)}),{once:!0})}))}d.warn("NativeWebKit.js is not enabled - run in the NativeWebKit app or enable the NativeWebKit Safari Web Extension")}window.__NATIVEWEBKIT_LISTENER_FLAG__||(window.__NATIVEWEBKIT_LISTENER_FLAG__=!0,d.log('adding "nativewebkit-receive" window listener'),window.addEventListener("nativewebkit-receive",(e=>{v(e.detail)})));const u=new t;function b(e,t){return 0===t?e:b(t,e%t)}function w(e){if(u.log("finding greatestCommonFactor of numbers",e),0==(e=e.filter((e=>e>0))).length)return null;const t=e.reduce(((e,t)=>b(e,t)));return u.log("greatestCommonFactor",t),0==t?null:t}const m=new t("AppMessagePoll");class f{static async#r(){return r()}static#l=[];static#d(e){return this.#l.includes(e)?(m.log("poll already included"),this.#l.indexOf(e)):this.#l.push(e)}static#c(e){return this.#l.includes(e)?(e.stop(),this.#l.splice(e,e.#h),this.#g(),!0):(m.log("poll wasn't included"),!1)}get#h(){return f.#l.indexOf(this)}#v;#p;#u=0;get interval(){return this.#p}set interval(e){e<=0?m.error(`invalid interval ${e}ms`):e!=this.#p?(this.#p=e,this.#b&&f.#g()):m.warn("assigning same interval")}constructor(e,t){this.#v=e,this.#p=t,f.#d(this)}static#w=null;static get#m(){return null!=this.#w}static#f=null;static get#E(){return this.#l.filter((e=>e.#y))}static get#A(){return this.#E.map((e=>e.#p))}static#M(){var e=w(this.#A);if(m.log(`new interval ${e}`),this.#f!=e)return m.log(`interval updated from ${this.#f} to ${e}`),this.#f=e,!0}static async#k(){const e=Date.now(),t=this.#E.filter((t=>e-t.#u>=t.#p)),s=t.map((e=>e.#v()));if(m.log("messages",s),s.length>0){const e=await p(s);m.log("didReceiveMessage?",e),e||m.error("app didn't receive message")}else m.log("no messages to send");t.forEach((t=>t.#u=e))}static async#L(){this.#m?m.log("tried to start AppMessagePoll when it's already running"):null!=this.#f?(m.log(`starting interval at ${this.#f}`),this.#w=window.setInterval(this.#k.bind(this),this.#f)):m.log("null interval")}static#I(){this.#m?(window.clearInterval(this.#w),this.#w=null):m.log("tried to stop AppMessagePoll when it already isn't running")}static#g(e=!1){if(!this.#m&&!e)return;const t=this.#M();this.#m||t?(m.log("restarting..."),this.#I(),this.#L()):m.log("no need to restart")}#y=!1;get#b(){return f.#m&&this.#y}async start(){await f.#r()?this.#b?m.log("poll is already running"):(this.#y=!0,f.#g(!0)):m.warn("polling is not enabled")}stop(){this.#b&&(this.#y=!1,f.#g())}destroy(){m.log("destroying poll",this),f.#c(this)}}window.AppMessagePoll=f;const E=new t("AudioSessionManager");class y extends l{static#U=[];get eventTypes(){return y.#U}static#T=new y;static get shared(){return this.#T}get _prefix(){return"as"}_formatMessage(e){return super._formatMessage(e)}addEventListener(e,t,s){return super.addEventListener(...arguments)}removeEventListener(e,t){return super.removeEventListener(...arguments)}hasEventListener(e,t){return super.hasEventListener(...arguments)}dispatchEvent(e){return super.dispatchEvent(...arguments)}constructor(){if(super(),this.shared)throw new Error("AudioSessionManager is a singleton - use AudioSessionManager.shared");g(this.#_.bind(this),this._prefix),window.addEventListener("load",(()=>{})),window.addEventListener("unload",(()=>{}))}#_(e){E.log(`received background message of type ${e.type}`,e);const{type:t}=e;E.error(`uncaught message type ${t}`)}}var A=y.shared;const M=new t("HeadphoneMotionManager");class k extends l{static#U=["isAvailable","isActive","motionData","sensorLocation"];get eventTypes(){return k.#U}static#T=new k;static get shared(){return this.#T}get _prefix(){return"hm"}_formatMessage(e){return super._formatMessage(e)}addEventListener(e,t,s){return super.addEventListener(...arguments)}removeEventListener(e,t){return super.removeEventListener(...arguments)}hasEventListener(e,t){return super.hasEventListener(...arguments)}dispatchEvent(e){return super.dispatchEvent(...arguments)}constructor(){if(super(),this.shared)throw new Error("HeadphoneMotionManager is a singleton - use HeadphoneMotionManager.shared");g(this.#_.bind(this),this._prefix),window.addEventListener("load",(()=>{this.#x&&this.checkIsAvailable()})),window.addEventListener("unload",(()=>{this.#D&&this.#$&&this.stopUpdates()}))}#x=!1;get checkAvailabilityOnLoad(){return this.#x}set checkAvailabilityOnLoad(e){if("boolean"!=typeof e)throw Error("invalid newValue for checkAvailabilityOnLoad",e);this.#x=e}#$=!1;get stopUpdatesOnUnload(){return this.#$}set stopUpdatesOnUnload(e){if("boolean"!=typeof e)throw Error("invalid newValue for stopUpdatesOnUnload",e);this.#$=e}#_(e){M.log(`received background message of type ${e.type}`,e);const{type:t}=e;switch(t){case"isAvailable":this.#P(e.isAvailable);break;case"isActive":this.#W(e.isActive);break;case"getData":this.#O(e.motionData);break;default:M.error(`uncaught message type ${t}`)}}#S=null;get isAvailable(){return Boolean(this.#S)}#P(e){this.#S!=e&&(this.#S=e,M.log(`updated isAvailable to ${e}`),this.dispatchEvent({type:"isAvailable",message:{isAvailable:this.isAvailable}}),this.#S&&this.checkIsActive())}async checkIsAvailable(){M.log("checking isAvailable..."),await p(this.#N)}get#N(){return this._formatMessage({type:"isAvailable"})}#D=null;get isActive(){return Boolean(this.#D)}#W(e){this.#D!=e&&(this.#D=e,M.log(`updated isActive to ${this.isActive}`),this.dispatchEvent({type:"isActive",message:{isActive:this.isActive}}),this.#R.stop(),this.#D?(M.log("starting motion data poll"),this.#C.start()):(M.log("stopping motion data poll"),this.#C.stop()))}async checkIsActive(){M.log("checking isActive"),await p(this.#K())}#K(){return this._formatMessage({type:"isActive"})}#R=new f(this.#K.bind(this),50);async startUpdates(){this.isAvailable?this.isActive?M.warn("already active"):(M.log("starting motion updates"),this.#R.start(),await p(this.#V)):M.warn("not available")}get#V(){return this._formatMessage({type:"startUpdates"})}async stopUpdates(){this.isAvailable?this.isActive?(M.log("stopping motion updates"),this.#R.start(),await p(this.#H)):M.warn("already inactive"):M.warn("not available")}get#H(){return this._formatMessage({type:"stopUpdates"})}async toggleMotionUpdates(){this.isAvailable?this.isActive?await this.stopUpdates():await this.startUpdates():M.log("not available")}#F;get motionData(){return this.#F}get#j(){return this.motionData?.timestamp||0}#B=null;get sensorLocation(){return this.#B}#G(e){this.#B!=e&&(this.#B=e,M.log(`updated sensor location to ${e}`),this.dispatchEvent({type:"sensorLocation",message:{sensorLocation:this.sensorLocation}}))}#O(e){this.#F=e,M.log("received headphone motion data",this.motionData),this.dispatchEvent({type:"motionData",message:{motionData:this.motionData}}),this.#G(e.sensorLocation)}async checkMotionData(){M.log("checkMotionData"),await p(this.#q)}#q(){return this._formatMessage({type:"getData",timestamp:this.#j})}#C=new f(this.#q.bind(this),20)}var L=k.shared;e.AudioSessionManager=A,e.HeadphoneMotionManager=L}));
